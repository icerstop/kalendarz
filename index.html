<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalendarz Nieobecności</title>
    <style>
        /* ------------------- */
        /* 1. Zmienne i Reset  */
        /* ------------------- */
        :root {
            --bg-main: #f4f4f9;
            --bg-card: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #6e6e73;
            --text-on-accent: #ffffff;
            --border-color: #d2d2d7;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --accent-color: #0071e3;
            --accent-color-hover: #0077ed;
            --absent-bg: #dc3545;
            --later-bg: #ffc107;
            --later-text: #1d1d1f;
            --weekend-bg: #d8d8d8;
            --weekend-text: #8a8a8e;
            --today-border: #0071e3;
            --icon-filter: invert(0%);
        }

        body.dark-theme {
            --bg-main: #131314;
            --bg-card: #1d1d1f;
            --text-primary: #f5f5f7;
            --text-secondary: #a1a1a6;
            --border-color: #3a3a3c;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --absent-bg: #e5484d;
            --later-bg: #ffc40c;
            --later-text: #1d1d1f;
            --weekend-bg: #2c2c2e;
            --weekend-text: #8d8d92;
            --icon-filter: invert(100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html {
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            padding: 32px 20px;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            overflow-x: hidden;
        }

        /* ------------------- */
        /* 2. Nagłówek         */
        /* ------------------- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .header-title h1 {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header-title p {
            color: var(--text-secondary);
            font-size: 15px;
            margin-top: 4px;
        }
        
        .theme-switcher {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 99px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        
        .theme-switcher button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .theme-switcher svg {
            width: 20px;
            height: 20px;
            fill: var(--text-secondary);
            transition: fill 0.2s;
        }
        
        .theme-switcher button.active svg {
            fill: var(--accent-color);
        }

        /* ------------------- */
        /* 3. Panel Główny    */
        /* ------------------- */
        .card {
            background-color: var(--bg-card);
            padding: 32px;
            border-radius: 16px;
            box-shadow: 0 4px 12px var(--shadow-color);
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .password-section {
            text-align: center;
            padding: 40px 0;
        }

        .password-container {
            display: inline-flex;
            gap: 12px;
            align-items: center;
        }

        .input-field {
            padding: 12px 18px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            width: 260px;
            transition: all 0.2s;
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-family: inherit;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        body.dark-theme .btn {
            background-color: rgba(255, 255, 255, 0.08);
        }
        
        .btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
            border-color: rgba(0, 0, 0, 0.2);
        }
        
        body.dark-theme .btn:hover {
            background-color: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: var(--text-on-accent);
            border: 1px solid var(--accent-color);
        }
        
        .btn-primary:hover {
            background-color: var(--accent-color-hover);
            border-color: var(--accent-color-hover);
        }
        
        .btn svg {
            width: 16px;
            height: 16px;
        }

        .error-message {
            color: var(--absent-bg);
            text-align: center;
            margin-top: 16px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .success-message {
            color: #16a34a;
            text-align: center;
            margin-top: 16px;
            font-weight: 500;
            font-size: 14px;
        }

        /* ------------------- */
        /* 4. Tryb Edycji     */
        /* ------------------- */
        .edit-mode {
            display: none;
        }

        .edit-mode.active {
            display: block;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 28px;
        }
        
        .mode-selector {
            display: flex;
            gap: 4px;
            padding: 4px;
            background-color: var(--bg-main);
            border-radius: 10px;
        }

        .mode-btn {
            padding: 8px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background-color: transparent;
            color: var(--text-secondary);
            font-family: inherit;
        }

        .mode-btn.active {
            background-color: var(--bg-card);
            color: var(--text-primary);
            box-shadow: 0 1px 3px var(--shadow-color);
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .file-input {
            display: none;
        }
        
        .legend {
            display: flex;
            gap: 24px;
            justify-content: center;
            flex-wrap: wrap;
            padding: 20px 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .legend-box {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }
        
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background-color: var(--bg-main);
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #16a34a;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ------------------- */
        /* 5. Kalendarz       */
        /* ------------------- */
        .month {
            margin-bottom: 48px;
        }
        .month:last-child {
            margin-bottom: 0;
        }

        .month-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            width: 100%;
            max-width: 100%;
        }

        .day-header {
            color: var(--text-secondary);
            padding: 12px 0;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
        }

        .day {
            position: relative;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            font-size: 15px;
            border-radius: 8px;
            transition: all 0.15s ease-out;
            background-color: var(--bg-card);
        }

        .day.clickable {
            cursor: pointer;
        }
        .day.clickable:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .day.clickable:active {
            transform: scale(0.95);
        }
        
        .day.today {
            box-shadow: inset 0 0 0 2px var(--today-border);
            color: var(--today-border);
            font-weight: 700;
        }

        .day.weekend {
            background-color: var(--weekend-bg);
            color: var(--weekend-text);
        }

        .day.absent {
            background-color: var(--absent-bg);
            color: var(--text-on-accent);
        }

        .day.later {
            background-color: var(--later-bg);
            color: var(--later-text);
        }

        .day.holiday::after {
            content: '';
            position: absolute;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            background-color: var(--accent-color);
            border-radius: 50%;
        }
        
        .empty-day {
            background-color: transparent;
        }

        /* ------------------- */
        /* 6. Responsywność   */
        /* ------------------- */
        @media (max-width: 768px) {
            body { 
                padding: 16px 12px;
                overflow-x: hidden;
            }
            .container {
                width: 100%;
                overflow-x: hidden;
            }
            .header { 
                flex-direction: column; 
                gap: 16px; 
                text-align: center; 
            }
            .header-title h1 { 
                font-size: 22px; 
            }
            .header-title p {
                font-size: 13px;
            }
            .theme-switcher {
                padding: 4px;
            }
            .theme-switcher svg {
                width: 18px;
                height: 18px;
            }
            .card { 
                padding: 20px 16px;
                border-radius: 12px;
            }
            .password-section {
                padding: 24px 0;
            }
            .password-container {
                flex-direction: column;
                width: 100%;
                gap: 10px;
            }
            .input-field {
                width: 100%;
                max-width: 100%;
                font-size: 16px;
            }
            .btn, .btn-primary {
                width: 100%;
                justify-content: center;
                padding: 14px 20px;
                font-size: 15px;
            }
            .controls { 
                flex-direction: column;
                gap: 16px;
            }
            .mode-selector {
                width: 100%;
                justify-content: center;
            }
            .action-buttons {
                width: 100%;
                flex-direction: column;
            }
            .action-buttons .btn {
                width: 100%;
            }
            .legend {
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }
            .day { 
                height: 48px; 
                font-size: 13px; 
                border-radius: 6px; 
            }
            .month-title { 
                font-size: 18px; 
            }
            .calendar { 
                gap: 2px; 
            }
            .day-header {
                font-size: 11px;
                padding: 8px 0;
            }
        }

        @media (max-width: 375px) {
            body {
                padding: 12px 8px;
            }
            .header-title h1 {
                font-size: 20px;
            }
            .card {
                padding: 16px 12px;
            }
            .day {
                height: 42px;
                font-size: 12px;
            }
            .day-header {
                font-size: 10px;
                padding: 6px 0;
            }
            .calendar {
                gap: 1px;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header class="header">
            <div class="header-title">
                <h1>Kuba - kalendarz nieobecności</h1>
                <p>1 października 2025 - 31 stycznia 2026</p>
            </div>
            <div class="theme-switcher">
                <button id="lightModeBtn" title="Tryb jasny">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1S11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.02-0.39-1.41,0 L3.17,6.00c-0.39,0.39-0.39,1.02,0,1.41c0.39,0.39,1.02,0.39,1.41,0l1.41-1.41C6.38,5.61,6.38,4.97,5.99,4.58z M18.36,16.95 c-0.39-0.39-1.02-0.39-1.41,0l-1.41,1.41c-0.39,0.39-0.39,1.02,0,1.41c0.39,0.39,1.02,0.39,1.41,0l1.41-1.41 C18.75,17.98,18.75,17.34,18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.02,0-1.41l-1.41-1.41c-0.39-0.39-1.02-0.39-1.41,0 c-0.39,0.39-0.39,1.02,0,1.41l1.41,1.41C18.4,6.38,19.03,6.38,19.42,5.99z M7.41,18.36c0.39-0.39,0.39-1.02,0-1.41l-1.41-1.41 c-0.39-0.39-1.02-0.39-1.41,0c-0.39,0.39-0.39,1.02,0,1.41l1.41,1.41C6.38,18.75,7.02,18.75,7.41,18.36z"></path></svg>
                </button>
                <button id="darkModeBtn" title="Tryb ciemny">
                     <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg>
                </button>
            </div>
        </header>
        
        <main>
            <div class="card" id="passwordSection">
                <div class="password-section">
                    <div class="password-container">
                        <input type="password" id="passwordInput" class="input-field" placeholder="Hasło dostępu">
                        <button class="btn btn-primary" id="passwordBtn">Odblokuj</button>
                    </div>
                    <div class="error-message" id="errorMessage"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="legend">
                    <div class="legend-item"><div class="legend-box" style="background-color: var(--absent-bg);"></div><span>Nieobecność</span></div>
                    <div class="legend-item"><div class="legend-box" style="background-color: var(--later-bg);"></div><span>Spóźnienie</span></div>
                    <div class="legend-item"><div class="legend-box" style="background-color: var(--weekend-bg); border: 1px solid var(--border-color);"></div><span>Weekend</span></div>
                    <div class="legend-item">Kropka pod datą ( • ) oznacza święto</div>
                </div>
            </div>
            
            <div class="edit-mode" id="editMode">
                <div class="card">
                     <div class="controls">
                        <div class="mode-selector">
                            <button class="mode-btn active" id="btnAbsent">Nieobecność</button>
                            <button class="mode-btn" id="btnLater">Spóźnienie</button>
                        </div>
                        <div class="action-buttons">
                            <div class="sync-status" id="syncStatus">
                                <div class="sync-dot"></div>
                                <span>Zsynchronizowano</span>
                            </div>
                            <button class="btn" id="btnDownload">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                <span>Pobierz listę</span>
                            </button>
                            <button class="btn" id="btnLogout">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                                <span>Wyloguj</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" id="calendarContainer"></div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Konfiguracja Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC7h72hvrQJyzH0s-36HewVBt-9Vbq1b6Y",
            authDomain: "kalendarz-nieobecnosci-a74c3.firebaseapp.com",
            projectId: "kalendarz-nieobecnosci-a74c3",
            storageBucket: "kalendarz-nieobecnosci-a74c3.firebasestorage.app",
            messagingSenderId: "960979808763",
            appId: "1:960979808763:web:f2baf0aaf25cde8c2b5b5e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Stan aplikacji
        const state = {
            absent: new Set(),
            later: new Set(),
            mode: 'absent',
            unlocked: false,
            theme: 'light'
        };

        const holidays = ['2025-11-11', '2025-12-25', '2025-12-26', '2026-01-01', '2026-01-06'];
        
        const monthsData = [
            { name: 'Październik 2025', year: 2025, month: 10, days: 31, start: 4 },
            { name: 'Listopad 2025', year: 2025, month: 11, days: 30, start: 7 },
            { name: 'Grudzień 2025', year: 2025, month: 12, days: 31, start: 2 },
            { name: 'Styczeń 2026', year: 2026, month: 1, days: 31, start: 5 }
        ];

        const today = new Date();
        const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
        
        // Inicjalizacja domyślnych danych
        const defaultAbsences = [
            '2025-10-02','2025-10-09','2025-10-16','2025-10-23','2025-10-30',
            '2025-11-05','2025-11-06','2025-11-07','2025-11-08','2025-11-09','2025-11-10','2025-11-11',
            '2025-11-13','2025-11-20','2025-11-27',
            '2025-12-04','2025-12-05','2025-12-06','2025-12-07','2025-12-08',
            '2025-12-11','2025-12-18','2025-12-25','2025-12-29','2025-12-30','2025-12-31',
            '2026-01-01','2026-01-02','2026-01-08','2026-01-15','2026-01-22','2026-01-29'
        ];
        
        // Nasłuchiwanie zmian w czasie rzeczywistym
        const calendarDocRef = doc(db, 'calendar', 'absences');
        
        onSnapshot(calendarDocRef, (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                state.absent = new Set(data.absent || []);
                state.later = new Set(data.later || []);
                render();
            }
        });
        
        async function initApp() {
            const savedTheme = localStorage.getItem('calendar_theme') || 'light';
            setTheme(savedTheme);

            try {
                const docSnap = await getDoc(calendarDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    state.absent = new Set(data.absent || []);
                    state.later = new Set(data.later || []);
                } else {
                    state.absent = new Set(defaultAbsences);
                    await saveData();
                }
            } catch (error) {
                console.error('Błąd wczytywania danych:', error);
                state.absent = new Set(defaultAbsences);
            }
            
            if (sessionStorage.getItem('calendar_unlocked') === 'true') {
                state.unlocked = true;
                showEditMode();
            }
            
            render();
            addEventListeners();
        }

        async function saveData() {
            try {
                await setDoc(calendarDocRef, {
                    absent: Array.from(state.absent),
                    later: Array.from(state.later),
                    lastUpdate: new Date().toISOString()
                });
                updateSyncStatus('Zsynchronizowano');
            } catch (error) {
                console.error('Błąd zapisu:', error);
                updateSyncStatus('Błąd synchronizacji');
            }
        }
        
        function updateSyncStatus(message) {
            const statusEl = document.getElementById('syncStatus');
            if (statusEl) {
                statusEl.querySelector('span').textContent = message;
            }
        }

        function render() {
            let html = '';
            const dayNames = ['Nie', 'Pon', 'Wto', 'Śro', 'Czw', 'Pią', 'Sob'];

            monthsData.forEach(function(m) {
                html += '<div class="month"><h2 class="month-title">' + m.name + '</h2><div class="calendar">';
                
                dayNames.forEach(function(d) {
                    html += '<div class="day-header">' + d + '</div>';
                });
                
                for (let i = 1; i < m.start; i++) {
                    html += '<div class="empty-day"></div>';
                }

                for (let day = 1; day <= m.days; day++) {
                    const dateStr = formatDate(m.year, m.month, day);
                    const classes = getDayClasses(m.year, m.month, day, dateStr);
                    const clickHandler = state.unlocked ? ' onclick="window.toggleDay(\'' + dateStr + '\')"' : '';
                    html += '<div class="' + classes + '"' + clickHandler + '>' + day + '</div>';
                }
                html += '</div></div>';
            });
            
            document.getElementById('calendarContainer').innerHTML = html;
        }

        function getDayClasses(year, month, day, dateStr) {
            const classes = ['day'];
            if (state.unlocked) classes.push('clickable');
            if (isWeekend(year, month, day)) classes.push('weekend');
            if (state.absent.has(dateStr)) classes.push('absent');
            if (state.later.has(dateStr)) classes.push('later');
            if (holidays.indexOf(dateStr) >= 0) classes.push('holiday');
            if (dateStr === todayStr) classes.push('today');
            return classes.join(' ');
        }
        
        function addEventListeners() {
            document.getElementById('passwordBtn').addEventListener('click', handleLogin);
            document.getElementById('passwordInput').addEventListener('keypress', function(e) { if (e.key === 'Enter') handleLogin(); });
            document.getElementById('btnAbsent').addEventListener('click', function() { setMode('absent'); });
            document.getElementById('btnLater').addEventListener('click', function() { setMode('later'); });
            document.getElementById('btnDownload').addEventListener('click', downloadList);
            document.getElementById('btnLogout').addEventListener('click', logout);
            document.getElementById('lightModeBtn').addEventListener('click', function() { setTheme('light'); });
            document.getElementById('darkModeBtn').addEventListener('click', function() { setTheme('dark'); });
        }

        function formatDate(year, month, day) {
            return year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
        }

        function isWeekend(year, month, day) {
            const d = new Date(year, month - 1, day).getDay();
            return d === 0 || d === 6;
        }
        
        window.toggleDay = async function(dateStr) {
            if (!state.unlocked) return;
            
            const targetSet = state.mode === 'absent' ? state.absent : state.later;
            const otherSet = state.mode === 'absent' ? state.later : state.absent;

            if (targetSet.has(dateStr)) {
                targetSet.delete(dateStr);
            } else {
                targetSet.add(dateStr);
                otherSet.delete(dateStr);
            }
            
            render();
            await saveData();
        };
        
        function setMode(newMode) {
            state.mode = newMode;
            document.getElementById('btnAbsent').classList.toggle('active', newMode === 'absent');
            document.getElementById('btnLater').classList.toggle('active', newMode === 'later');
        }

        function showEditMode() {
            document.getElementById('passwordSection').style.display = 'none';
            document.getElementById('editMode').classList.add('active');
            render();
        }

        function logout() {
            state.unlocked = false;
            sessionStorage.removeItem('calendar_unlocked');
            document.getElementById('passwordSection').style.display = 'block';
            document.getElementById('editMode').classList.remove('active');
            document.getElementById('passwordInput').value = '';
            document.getElementById('errorMessage').textContent = '';
            render();
        }

        async function handleLogin() {
            const password = document.getElementById('passwordInput').value;
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashHex = Array.from(new Uint8Array(hashBuffer)).map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
            
            const correctHash = 'e54f15db430c968e8da2414cc0a37f094aa0182f35262af005cdcb19e344eeeb';

            if (hashHex === correctHash) {
                state.unlocked = true;
                sessionStorage.setItem('calendar_unlocked', 'true');
                document.getElementById('errorMessage').textContent = '';
                showEditMode();
            } else {
                document.getElementById('errorMessage').textContent = 'Nieprawidłowe hasło';
            }
        }
        
        function setTheme(theme) {
            state.theme = theme;
            document.body.classList.toggle('dark-theme', theme === 'dark');
            document.getElementById('lightModeBtn').classList.toggle('active', theme === 'light');
            document.getElementById('darkModeBtn').classList.toggle('active', theme === 'dark');
            localStorage.setItem('calendar_theme', theme);
        }

        function downloadList() {
            let text = 'KALENDARZ NIEOBECNOŚCI\n';
            text += 'Okres: 1 października 2025 - 31 stycznia 2026\n\n';
            
            if (state.absent.size > 0) {
                text += '=== DNI NIEOBECNOŚCI ===\n';
                Array.from(state.absent).sort().forEach(function(d) {
                    const parts = d.split('-');
                    text += parts[2] + '.' + parts[1] + '.' + parts[0] + '\n';
                });
                text += '\nŁącznie: ' + state.absent.size + ' dni\n\n';
            }
            if (state.later.size > 0) {
                text += '=== DNI SPÓŹNIEŃ ===\n';
                Array.from(state.later).sort().forEach(function(d) {
                    const parts = d.split('-');
                    text += parts[2] + '.' + parts[1] + '.' + parts[0] + '\n';
                });
                text += '\nŁącznie: ' + state.later.size + ' dni\n';
            }
            
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'nieobecnosci.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
