import React, { useState, useEffect } from 'react';
import { Download, X, Upload } from 'lucide-react';

const AbsenceCalendar = () => {
  const [selectedDates, setSelectedDates] = useState(new Set());
  const [laterDates, setLaterDates] = useState(new Set());
  const [activeMode, setActiveMode] = useState('absent'); // 'absent' or 'later'

  const holidays = new Set([
    '2025-11-11', // Święto Niepodległości
    '2025-12-25', // Boże Narodzenie
    '2025-12-26', // Drugi dzień Bożego Narodzenia
    '2026-01-01'  // Nowy Rok
  ]);

  // Początkowe dane - nie będę we wszystkie czwartki i wskazane okresy
  const initialAbsences = () => {
    const dates = new Set();
    
    // Wszystkie czwartki
    const thursdays = [
      '2025-10-02', '2025-10-09', '2025-10-16', '2025-10-23', '2025-10-30',
      '2025-11-06', '2025-11-13', '2025-11-20', '2025-11-27',
      '2025-12-04', '2025-12-11', '2025-12-18', '2025-12-25',
      '2026-01-08', '2026-01-15', '2026-01-22', '2026-01-29'
    ];
    thursdays.forEach(d => dates.add(d));
    
    // 5-11 listopada
    for (let day = 5; day <= 11; day++) {
      dates.add(`2025-11-${String(day).padStart(2, '0')}`);
    }
    
    // 29 grudnia - 2 stycznia
    dates.add('2025-12-29');
    dates.add('2025-12-30');
    dates.add('2025-12-31');
    dates.add('2026-01-01');
    dates.add('2026-01-02');
    
    // 5-8 grudnia
    for (let day = 5; day <= 8; day++) {
      dates.add(`2025-12-${String(day).padStart(2, '0')}`);
    }
    
    return dates;
  };

  // Wczytaj dane z localStorage przy starcie
  useEffect(() => {
    const savedAbsent = localStorage.getItem('absenceCalendar_absent');
    const savedLater = localStorage.getItem('absenceCalendar_later');
    
    if (savedAbsent) {
      setSelectedDates(new Set(JSON.parse(savedAbsent)));
    } else {
      // Jeśli nie ma zapisanych danych, użyj początkowych
      setSelectedDates(initialAbsences());
    }
    
    if (savedLater) {
      setLaterDates(new Set(JSON.parse(savedLater)));
    }
  }, []);

  // Zapisz dane do localStorage przy każdej zmianie
  useEffect(() => {
    localStorage.setItem('absenceCalendar_absent', JSON.stringify(Array.from(selectedDates)));
  }, [selectedDates]);

  useEffect(() => {
    localStorage.setItem('absenceCalendar_later', JSON.stringify(Array.from(laterDates)));
  }, [laterDates]);

  const months = [
    { name: 'Październik 2025', year: 2025, month: 9, startDay: 1, endDay: 31 },
    { name: 'Listopad 2025', year: 2025, month: 10, startDay: 1, endDay: 30 },
    { name: 'Grudzień 2025', year: 2025, month: 11, startDay: 1, endDay: 31 },
    { name: 'Styczeń 2026', year: 2026, month: 0, startDay: 1, endDay: 31 }
  ];

  const formatDate = (year, month, day) => {
    return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
  };

  const isWeekend = (year, month, day) => {
    const date = new Date(year, month, day);
    const dayOfWeek = date.getDay();
    return dayOfWeek === 0 || dayOfWeek === 6;
  };

  const isHoliday = (year, month, day) => {
    const dateStr = formatDate(year, month, day);
    return holidays.has(dateStr);
  };

  const toggleDate = (year, month, day) => {
    const dateStr = formatDate(year, month, day);
    
    if (activeMode === 'absent') {
      const newSelected = new Set(selectedDates);
      const newLater = new Set(laterDates);
      
      if (newSelected.has(dateStr)) {
        newSelected.delete(dateStr);
      } else {
        newSelected.add(dateStr);
        newLater.delete(dateStr);
      }
      
      setSelectedDates(newSelected);
      setLaterDates(newLater);
    } else {
      const newLater = new Set(laterDates);
      const newSelected = new Set(selectedDates);
      
      if (newLater.has(dateStr)) {
        newLater.delete(dateStr);
      } else {
        newLater.add(dateStr);
        newSelected.delete(dateStr);
      }
      
      setLaterDates(newLater);
      setSelectedDates(newSelected);
    }
  };

  const downloadCalendar = () => {
    const absentDays = Array.from(selectedDates).sort();
    const laterDays = Array.from(laterDates).sort();
    
    let content = 'KIEDY MNIE NIE BĘDZIE :-----------)\n\n';
    content += `Okres: 1 października 2025 - 31 stycznia 2026\n\n`;
    
    if (absentDays.length > 0) {
      content += '=== DNI NIEOBECNOŚCI ===\n';
      absentDays.forEach(date => {
        const [year, month, day] = date.split('-');
        const dateObj = new Date(year, month - 1, day);
        const dayName = dateObj.toLocaleDateString('pl-PL', { weekday: 'long' });
        content += `${day}.${month}.${year} (${dayName})\n`;
      });
      content += `\nŁącznie dni nieobecności: ${absentDays.length}\n\n`;
    }
    
    if (laterDays.length > 0) {
      content += '=== DNI SPÓŹNIEŃ (przyjście później) ===\n';
      laterDays.forEach(date => {
        const [year, month, day] = date.split('-');
        const dateObj = new Date(year, month - 1, day);
        const dayName = dateObj.toLocaleDateString('pl-PL', { weekday: 'long' });
        content += `${day}.${month}.${year} (${dayName})\n`;
      });
      content += `\nŁącznie dni spóźnień: ${laterDays.length}\n`;
    }
    
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'nieobecnosci.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const exportData = () => {
    const data = {
      absent: Array.from(selectedDates),
      later: Array.from(laterDates)
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'kalendarz_backup.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const importData = (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          setSelectedDates(new Set(data.absent || []));
          setLaterDates(new Set(data.later || []));
        } catch (error) {
          alert('Błąd podczas wczytywania pliku!');
        }
      };
      reader.readAsText(file);
    }
  };

  const clearAll = () => {
    if (confirm('Czy na pewno chcesz wyczyścić wszystkie zaznaczenia?')) {
      setSelectedDates(new Set());
      setLaterDates(new Set());
    }
  };

  const renderMonth = (monthData) => {
    const { name, year, month, startDay, endDay } = monthData;
    const firstDay = new Date(year, month, 1).getDay();
    const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1;
    
    const days = [];
    
    for (let i = 0; i < adjustedFirstDay; i++) {
      days.push(<div key={`empty-${i}`} className="h-16"></div>);
    }
    
    for (let day = startDay; day <= endDay; day++) {
      const dateStr = formatDate(year, month, day);
      const weekend = isWeekend(year, month, day);
      const holiday = isHoliday(year, month, day);
      const isAbsent = selectedDates.has(dateStr);
      const isLater = laterDates.has(dateStr);
      
      let bgColor = 'bg-white hover:bg-gray-50';
      if (weekend || holiday) bgColor = 'bg-gray-100';
      if (isAbsent) bgColor = 'bg-red-400 hover:bg-red-500';
      if (isLater) bgColor = 'bg-yellow-300 hover:bg-yellow-400';
      
      days.push(
        <div key={day} className="relative">
          <button
            onClick={() => toggleDate(year, month, day)}
            className={`w-full h-16 border border-gray-300 ${bgColor} transition-colors flex items-center justify-center font-semibold cursor-pointer`}
          >
            {day}
          </button>
          {holiday && (
            <div className="absolute top-0 right-0 bg-blue-500 text-white text-xs px-1 rounded-bl">
              Święto
            </div>
          )}
        </div>
      );
    }
    
    return (
      <div key={name} className="mb-8">
        <h3 className="text-xl font-bold mb-3 text-gray-800">{name}</h3>
        <div className="grid grid-cols-7 gap-0 border border-gray-300">
          {['Pn', 'Wt', 'Śr', 'Cz', 'Pt', 'So', 'Nd'].map(day => (
            <div key={day} className="bg-gray-200 border border-gray-300 p-2 text-center font-bold text-sm">
              {day}
            </div>
          ))}
          {days}
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-lg shadow-xl p-6 mb-6">
          <h1 className="text-3xl font-bold text-center mb-2 text-gray-800">
            KIEDY MNIE NIE BĘDZIE :-----------)
          </h1>
          <p className="text-center text-gray-600 mb-4">
            1 października 2025 - 31 stycznia 2026
          </p>
          
          <div className="mb-6">
            <p className="text-center text-sm font-semibold mb-3 text-gray-700">
              Wybierz tryb zaznaczania:
            </p>
            <div className="flex gap-4 justify-center">
              <button
                onClick={() => setActiveMode('absent')}
                className={`px-6 py-3 rounded-lg border-2 transition-all ${
                  activeMode === 'absent'
                    ? 'bg-red-400 border-red-600 text-white font-bold shadow-lg scale-105'
                    : 'bg-red-200 border-red-300 text-red-800 hover:bg-red-300'
                }`}
              >
                🚫 Nie będzie mnie
              </button>
              <button
                onClick={() => setActiveMode('later')}
                className={`px-6 py-3 rounded-lg border-2 transition-all ${
                  activeMode === 'later'
                    ? 'bg-yellow-300 border-yellow-500 text-gray-800 font-bold shadow-lg scale-105'
                    : 'bg-yellow-100 border-yellow-200 text-yellow-800 hover:bg-yellow-200'
                }`}
              >
                ⏰ Przychodzę później
              </button>
            </div>
          </div>

          <div className="flex flex-wrap gap-4 justify-center mb-4">
            <div className="flex items-center gap-2">
              <div className="w-6 h-6 bg-red-400 border border-gray-300"></div>
              <span className="text-sm">Nie będzie mnie</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-6 h-6 bg-yellow-300 border border-gray-300"></div>
              <span className="text-sm">Przychodzę później</span>
            </div>
            <div className="flex items-center gap-2">
              <div className="w-6 h-6 bg-gray-100 border border-gray-300"></div>
              <span className="text-sm">Weekend/Święto</span>
            </div>
          </div>

          <div className="text-center text-sm text-gray-600 mb-4">
            <p className="font-semibold">Kliknij najpierw w wybrany kolor (tryb), a potem klikaj w dni w kalendarzu</p>
            <p className="text-xs mt-1">Dane zapisują się automatycznie w przeglądarce</p>
          </div>
          
          <div className="flex flex-wrap gap-3 justify-center">
            <button
              onClick={downloadCalendar}
              className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors"
            >
              <Download size={20} />
              Pobierz listę
            </button>
            <button
              onClick={exportData}
              className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors"
            >
              <Download size={20} />
              Eksportuj dane
            </button>
            <label className="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors cursor-pointer">
              <Upload size={20} />
              Importuj dane
              <input type="file" accept=".json" onChange={importData} className="hidden" />
            </label>
            <button
              onClick={clearAll}
              className="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors"
            >
              <X size={20} />
              Wyczyść wszystko
            </button>
          </div>
          
          <div className="mt-4 text-center">
            <p className="text-sm text-gray-600">
              Zaznaczono nieobecności: <span className="font-bold text-red-600">{selectedDates.size}</span> dni
            </p>
            <p className="text-sm text-gray-600">
              Zaznaczono spóźnienia: <span className="font-bold text-yellow-600">{laterDates.size}</span> dni
            </p>
          </div>
        </div>
        
        <div className="bg-white rounded-lg shadow-xl p-6">
          {months.map(renderMonth)}
        </div>
      </div>
    </div>
  );
};

export default AbsenceCalendar;
